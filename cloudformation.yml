AWSTemplateFormatVersion: 2010-09-09
Parameters:
  TeastoreInstanceType:
    Type: String
    Default: c4.xlarge
    Description: Default is c4.xlarge
  TeastoreInstances:
    Type: Number
    Default: "4"
    Description: Default is 4 instances. Cluster will always have this number of instances
  LocustInstances:    
    Type: Number
    Default: "2"
    Description: Default is 2 instances. Cluster will always have this number of instances
  LocustInstanceType:
    Type: String
    Default: c4.xlarge
    Description: Default is t3.medium
  ClustersARN:
    Type: String
    Description: Cluster ARN
  ClustersSubnetIds:
    Description: Subnet IDs
    Type: "List<AWS::EC2::Subnet::Id>"

Resources:
  EKSTeastore:
    Type: "AWS::EKS::Cluster"
    Properties:
      Name: app-cluster
      RoleArn: !Ref ClustersARN
      ResourcesVpcConfig:
        SubnetIds: !Ref ClustersSubnetIds
  EKSTeastoreNodegroup:
    Type: "AWS::EKS::Nodegroup"
    Properties:
      AmiType: AL2_x86_64
      CapacityType: ON_DEMAND
      ClusterName: app-cluster
      ScalingConfig:
        MinSize: !Ref TeastoreInstances
        DesiredSize: !Ref TeastoreInstances
        MaxSize: !Ref TeastoreInstances
      InstanceTypes:
        - !Ref TeastoreInstanceType
      NodegroupName: teastoreclusternodegroup
      NodeRole: !Ref ClustersARN
      Subnets: !Ref ClustersSubnetIds
    DependsOn: EKSTeastore
  EKSLoadTest:
    Type: "AWS::EKS::Cluster"
    Properties:
      Name: loadtester-cluster
      RoleArn: !Ref ClustersARN
      ResourcesVpcConfig:
        SubnetIds: !Ref ClustersSubnetIds
  EKSLoadTestNodegroup:
    Type: "AWS::EKS::Nodegroup"
    Properties:
      AmiType: AL2_x86_64
      CapacityType: ON_DEMAND
      ClusterName: loadtester-cluster
      ScalingConfig:
        MinSize: !Ref LocustInstances
        DesiredSize: !Ref LocustInstances
        MaxSize: !Ref LocustInstances
      InstanceTypes:
        - !Ref LocustInstanceType
      NodegroupName: teastoreloadtesternodegroup
      NodeRole: !Ref ClustersARN
      Subnets: !Ref ClustersSubnetIds
    DependsOn: EKSLoadTest
  TeastoreWebUIPort:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      CidrIp: "0.0.0.0/0"
      Description: "Webui"
      FromPort: 30080
      GroupId: !GetAtt EKSTeastore.ClusterSecurityGroupId
      IpProtocol: tcp
      ToPort: 30080
  TeastoreLocustPort:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      CidrIp: "0.0.0.0/0"
      Description: "Locust"
      FromPort: 32001
      GroupId: !GetAtt EKSLoadTest.ClusterSecurityGroupId
      IpProtocol: tcp
      ToPort: 32001
